; OPENTEST.COM - Simple file open test
    CPU     186
    ORG     0x0100

start:
    ; Print "Opening..."
    mov     ah, 0x09
    mov     dx, msg1
    int     0x21

    ; Open ALLCANM1
    mov     dx, filename
    mov     ax, 0x3D00
    int     0x21
    jc      .error

    ; AX should contain handle
    ; Print it as decimal
    push    ax
    mov     ah, 0x09
    mov     dx, msg2
    int     0x21
    pop     ax

    ; Convert AX to decimal and print
    ; Simple: just print each digit
    xor     cx, cx          ; digit count
    mov     bx, 10
.div_loop:
    xor     dx, dx
    div     bx              ; AX = AX/10, DX = AX%10
    push    dx              ; save digit
    inc     cx
    test    ax, ax
    jnz     .div_loop

    ; Print digits
.print_loop:
    pop     dx
    add     dl, '0'
    mov     ah, 0x02
    int     0x21
    loop    .print_loop

    ; Print newline
    mov     ah, 0x09
    mov     dx, crlf
    int     0x21

    ; Try to read
    mov     ah, 0x09
    mov     dx, msg3
    int     0x21

    mov     bx, 5           ; handle 5 (first file handle after stdhandles)
    mov     cx, 10
    mov     dx, buffer
    mov     ah, 0x3F
    int     0x21
    jc      .read_err

    ; Print bytes read
    push    ax
    mov     ah, 0x09
    mov     dx, msg4
    int     0x21
    pop     ax

    ; Print AX as decimal
    xor     cx, cx
    mov     bx, 10
.div2_loop:
    xor     dx, dx
    div     bx
    push    dx
    inc     cx
    test    ax, ax
    jnz     .div2_loop
.print2_loop:
    pop     dx
    add     dl, '0'
    mov     ah, 0x02
    int     0x21
    loop    .print2_loop

    mov     ah, 0x09
    mov     dx, crlf
    int     0x21

    mov     ax, 0x4C00
    int     0x21

.error:
    mov     ah, 0x09
    mov     dx, errmsg
    int     0x21
    mov     ax, 0x4C01
    int     0x21

.read_err:
    mov     ah, 0x09
    mov     dx, rderr
    int     0x21
    mov     ax, 0x4C02
    int     0x21

filename db 'ALLCANM1', 0
msg1    db 'Opening ALLCANM1...', 0x0D, 0x0A, '$'
msg2    db 'Handle: $'
msg3    db 'Reading 10 bytes with handle 5...', 0x0D, 0x0A, '$'
msg4    db 'Bytes read: $'
errmsg  db 'Open failed!', 0x0D, 0x0A, '$'
rderr   db 'Read failed!', 0x0D, 0x0A, '$'
crlf    db 0x0D, 0x0A, '$'
buffer  times 512 db 0
