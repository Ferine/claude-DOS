#!/bin/bash
# ===========================================================================
# ClaudeDOS Pre-Commit Hook
# ===========================================================================
# Validates build and runs smoke test before allowing commit.
#
# Install: git config core.hooksPath .githooks
# ===========================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}[pre-commit]${NC} Running ClaudeDOS validation..."

# ===========================================================================
# 1. Build Validation
# ===========================================================================

echo -e "${GREEN}[pre-commit]${NC} Building floppy image..."

if ! make -C "$PROJECT_DIR" > /tmp/claudedos-build.log 2>&1; then
    echo -e "${RED}[pre-commit]${NC} Build FAILED"
    echo ""
    cat /tmp/claudedos-build.log | grep -E "(error:|undefined|No such file)" | head -20
    echo ""
    echo -e "${YELLOW}Fix build errors before committing.${NC}"
    rm -f /tmp/claudedos-build.log
    exit 1
fi

rm -f /tmp/claudedos-build.log

# ===========================================================================
# 2. Floppy Size Check
# ===========================================================================

FLOPPY="$PROJECT_DIR/images/floppy.img"
MAX_SIZE=1474560

if [ -f "$FLOPPY" ]; then
    SIZE=$(stat -f%z "$FLOPPY" 2>/dev/null || stat -c%s "$FLOPPY")
    PCT=$((SIZE * 100 / MAX_SIZE))

    if [ "$SIZE" -gt "$MAX_SIZE" ]; then
        echo -e "${RED}[pre-commit]${NC} Floppy image exceeds 1.44MB! ($SIZE bytes)"
        echo -e "${YELLOW}Remove files to fit on floppy.${NC}"
        exit 1
    fi

    if [ "$PCT" -gt 95 ]; then
        echo -e "${YELLOW}[pre-commit]${NC} Warning: Floppy is ${PCT}% full"
    else
        echo -e "${GREEN}[pre-commit]${NC} Floppy size OK: ${PCT}% full"
    fi
fi

# ===========================================================================
# 3. Quick Smoke Test (optional - set SKIP_SMOKE=1 to skip)
# ===========================================================================

if [ "${SKIP_SMOKE:-0}" = "1" ]; then
    echo -e "${YELLOW}[pre-commit]${NC} Skipping smoke test (SKIP_SMOKE=1)"
else
    echo -e "${GREEN}[pre-commit]${NC} Running smoke test..."

    SOCKET="/tmp/qemu-precommit-$$.sock"
    rm -f "$SOCKET"

    # Start QEMU headless
    qemu-system-i386 \
        -fda "$FLOPPY" \
        -boot a \
        -m 4 \
        -display none \
        -monitor unix:"$SOCKET",server,nowait \
        2>/dev/null &
    QEMU_PID=$!

    # Wait for boot
    sleep 4

    # Test: type "hello" and check it doesn't crash
    {
        sleep 0.3
        echo "sendkey h"
        sleep 0.05
        echo "sendkey e"
        sleep 0.05
        echo "sendkey l"
        sleep 0.05
        echo "sendkey l"
        sleep 0.05
        echo "sendkey o"
        sleep 0.05
        echo "sendkey ret"
        sleep 2
    } | nc -U "$SOCKET" > /dev/null 2>&1 || true

    # Check if QEMU is still running (didn't crash)
    if kill -0 $QEMU_PID 2>/dev/null; then
        echo -e "${GREEN}[pre-commit]${NC} Smoke test PASSED"
        kill $QEMU_PID 2>/dev/null || true
    else
        echo -e "${RED}[pre-commit]${NC} Smoke test FAILED - QEMU crashed"
        rm -f "$SOCKET"
        exit 1
    fi

    wait $QEMU_PID 2>/dev/null || true
    rm -f "$SOCKET"
fi

# ===========================================================================
# Success
# ===========================================================================

echo -e "${GREEN}[pre-commit]${NC} All checks passed!"
exit 0
